<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Docker Hardened Image (DHI) Demo</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container">
        <header>
            <h1>Docker Hardened Image Demo</h1>
            <p class="subtitle">Comparing Standard Base Images vs. DHI (The New Secure Standard)</p>
        </header>

        <div class="grid">
            <!-- Security Health Score -->
            <div class="card">
                <h2>Security Health Score</h2>
                <div class="health-score-container">
                    <div class="gauge" id="health-gauge">
                        <span class="gauge-text" id="health-score-text">0%</span>
                    </div>
                    <div class="score-label" id="health-label">Critical Risk</div>
                </div>
                <p style="text-align: center; color: var(--text-muted); font-size: 0.8rem; margin-top: 0.5rem;">
                    Aggregated score based on identity, attack surface, and filesystem lockdown.
                </p>
            </div>

            <!-- Environment Stats -->
            <div class="card">
                <h2>Environment Specs</h2>
                <div class="card-content" id="env-stats">
                    <p>Loading environmental data...</p>
                </div>
            </div>

            <!-- Privilege escalation Test -->
            <div class="card">
                <h2>File System Lockdown</h2>
                <div class="card-content">
                    <p>Attempt to write to the <code>/root</code> directory to test for privilege escalation
                        vulnerabilities.</p>
                    <button id="privilege-btn" onclick="testPrivilege()" class="badge-danger">Try Privilege
                        Escalation</button>
                    <div id="privilege-result" class="breach-alert" style="display: none;"></div>
                </div>
            </div>
        </div>

        <div class="grid" style="margin-top: -1.5rem;">
            <!-- Attack Surface Scan -->
            <div class="card">
                <h2>Attack Surface Scan</h2>
                <div class="card-content">
                    <p>Check if common exploitation tools are present in this container.</p>
                    <button onclick="runScan()" style="background: var(--border); color: #fff;">Run Diagnostic
                        Scan</button>
                    <div id="scan-results" style="margin-top: 1rem;"></div>
                </div>
            </div>

            <!-- DHI Features -->
            <div class="card">
                <h2>DHI Security Pillars</h2>
                <div class="card-content">
                    <div class="dhi-features">
                        <div class="feature-tag">Near-Zero CVEs</div>
                        <div class="feature-tag">SLSA Level 3</div>
                        <div class="feature-tag">Signed SBOM</div>
                        <div class="feature-tag">Drop-in Ease</div>
                        <div class="feature-tag">Distroless</div>
                        <div class="feature-tag">Non-root Default</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Terminal Output -->
        <div class="card" style="margin-bottom: 2rem;">
            <h2>Command Execution Diagnostic</h2>
            <div class="card-content">
                <p>Verify if the shell is accessible for arbitrary command execution.</p>
                <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                    <input type="text" id="command-input" placeholder="e.g., whoami"
                        style="flex: 1; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid var(--border); background: #000; color: #fff;">
                    <button onclick="runCommand()" style="width: auto; margin-top: 0;">Execute</button>
                </div>
                <pre id="command-output">Output will appear here...</pre>
            </div>
        </div>
    </div>

    <script>
        let securityStatus = {
            isNonRoot: false,
            toolsAbsent: 0,
            totalTools: 8,
            writeDenied: false,
            testsRun: { env: false, scan: false, privilege: false }
        };

        function updateHealthScore() {
            let score = 0;
            if (securityStatus.isNonRoot) score += 25;

            // Proportional tool score (max 40)
            const toolScore = (securityStatus.toolsAbsent / securityStatus.totalTools) * 40;
            score += Math.round(toolScore);

            if (securityStatus.writeDenied) score += 35;

            const gauge = document.getElementById('health-gauge');
            const scoreText = document.getElementById('health-score-text');
            const label = document.getElementById('health-label');

            scoreText.textContent = `${score}%`;

            // Dynamic Gauge Color
            let color = 'var(--danger)';
            let statusText = 'Critical Risk';
            if (score > 30) { color = '#f59e0b'; statusText = 'Moderate Risk'; }
            if (score > 70) { color = '#fbbf24'; statusText = 'Safe-ish'; }
            if (score > 90) { color = 'var(--success)'; statusText = 'Hardened (DHI)'; }

            gauge.style.background = `conic-gradient(${color} ${score * 3.6}deg, #334155 0deg)`;
            label.textContent = statusText;
            label.style.color = color;
        }

        async function fetchEnv() {
            try {
                const res = await fetch('/api/env');
                const data = await res.json();

                securityStatus.isNonRoot = data.user !== 'root';
                securityStatus.testsRun.env = true;

                const containerType = securityStatus.isNonRoot ?
                    '<span class="badge badge-success">Lower Risk (Non-root)</span>' :
                    '<span class="badge badge-danger">High Risk (Root)</span>';

                document.getElementById('env-stats').innerHTML = `
                    <div class="stat-item"><span class="label">OS Type</span><span class="value">${data.os}</span></div>
                    <div class="stat-item"><span class="label">User</span><span class="value">${data.user}</span></div>
                    <div class="stat-item"><span class="label">Security Context</span><span class="value">${containerType}</span></div>
                    <div class="stat-item"><span class="label">Node Version</span><span class="value">${data.nodeVersion}</span></div>
                    <div class="stat-item"><span class="label">Platform</span><span class="value">${data.platform} (${data.arch})</span></div>
                `;
                updateHealthScore();
            } catch (e) {
                document.getElementById('env-stats').innerHTML = '<p style="color:red">Failed to load data.</p>';
            }
        }

        async function runScan() {
            const resultsDiv = document.getElementById('scan-results');
            resultsDiv.innerHTML = '<p>Scanning binaries...</p>';
            try {
                const res = await fetch('/api/scan');
                const data = await res.json();

                let absentCount = 0;
                resultsDiv.innerHTML = Object.entries(data).map(([tool, present]) => {
                    if (!present) absentCount++;
                    return `
                        <div class="stat-item">
                            <span class="label">${tool}</span>
                            <span class="value">${present ?
                            '<span class="badge badge-danger">PRESENT</span>' :
                            '<span class="badge badge-success">ABSENT</span>'}</span>
                        </div>
                    `;
                }).join('');

                securityStatus.toolsAbsent = absentCount;
                securityStatus.testsRun.scan = true;
                updateHealthScore();
            } catch (e) {
                resultsDiv.innerHTML = '<p style="color:red">Scan failed. (Pillar: Minimalism)</p>';
                securityStatus.toolsAbsent = securityStatus.totalTools; // Assume all absent if shell is dead
                updateHealthScore();
            }
        }

        async function testPrivilege() {
            const resultDiv = document.getElementById('privilege-result');
            const btn = document.getElementById('privilege-btn');

            resultDiv.style.display = 'block';
            resultDiv.textContent = 'Testing permissions...';

            try {
                const res = await fetch('/api/test-privilege');
                const data = await res.json();

                if (data.success) {
                    resultDiv.className = 'breach-alert breach-denied'; // Denied means breach succeeded in this context
                    resultDiv.innerHTML = `<strong>‚ö†Ô∏è VULNERABILITY!</strong><br>${data.message}`;
                    securityStatus.writeDenied = false;
                } else {
                    resultDiv.className = 'breach-alert breach-success';
                    resultDiv.innerHTML = `<strong>üõ°Ô∏è SECURE</strong><br>${data.message}`;
                    securityStatus.writeDenied = true;
                }

                securityStatus.testsRun.privilege = true;
                updateHealthScore();
            } catch (e) {
                resultDiv.className = 'breach-alert breach-success';
                resultDiv.innerHTML = `<strong>üõ°Ô∏è SECURE</strong><br>Access Denied (Pillar: Distroless/Non-root)`;
                securityStatus.writeDenied = true;
                updateHealthScore();
            }
        }

        async function runCommand() {
            const cmd = document.getElementById('command-input').value;
            const output = document.getElementById('command-output');
            output.textContent = 'Executing...';
            try {
                const res = await fetch('/api/exec', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command: cmd })
                });
                const data = await res.json();
                output.textContent = data.stdout || data.stderr || data.error || 'No output.';
            } catch (e) {
                output.textContent = 'Fetch Error: The command failed because the underlying shell might be missing (DHI Pillar: Minimalism).';
            }
        }

        fetchEnv();
    </script>
</body>

</html>