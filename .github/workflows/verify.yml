name: DHI Security Verification

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install Docker Scout
        run: |
          curl -sSfL https://raw.githubusercontent.com/docker/scout-cli/main/install.sh | sh -s --
          echo "$HOME/bin" >> $GITHUB_PATH

      - name: Docker Login (Docker Hub)
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PAT }}

      - name: Docker Login (DHI)
        uses: docker/login-action@v3
        with:
          registry: dhi.io
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PAT }}

      - name: Build Hardened Image
        run: |
          docker build --load -t dhi-demo:hardened -f Dockerfile.hardened .

      - name: Verify DHI Signature (Hard Gate)
        run: |
          # Verify that the base image is an authentic DHI image
          docker scout attest get dhi.io/node:24 --predicate-type https://scout.docker.com/sbom/v0.1 --verify

      - name: Vulnerability Scan (Hard Gate)
        run: |
          # Fail the build if any Critical or High vulnerabilities are found
          docker scout cves dhi-demo:hardened --exit-code --severity high,critical
